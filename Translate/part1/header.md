# Заголовок

Давайте вернемся к определенной строке в начале `hello-world.asm`.

```rgbasm,linenos,start=7
{{#include ../assets/hello-world.asm:10}}
```

Что это за таинственный заголовок, почему мы освобождаем для него место и другие вопросы, на которые мы ответим в этом уроке!

## Что такое заголовок?

Первым делом нужно объяснение, что *это*?
Это область памяти от $0104 до $014F (включительно).
Она содержит метаданные о ROM, такие как: название, совместимость с Game Boy Color, размер,
две контрольные суммы и, что интересно, логотип Nintendo, который отображается во время анимации включения питания.

::: tip

Вы можете найти эту информацию и многое другое [здесь](https://gbdev.io/pandocs/The_Cartridge_Header).

:::

Интересно, что большая часть информации в заголовке не имеет значения на самой консоли (размер ROM определяется только емкостью микросхемы в картридже, а не байтом заголовка).
На самом деле, некоторые прототипы ROMа на самом деле содержат неверную информацию в заголовке!

Большая часть заголовка использовалась производственным отделом Nintendo только для того, чтобы знать, какие компоненты следует поместить в картридж при публикации ROMа.
Таким образом, только ROMы, отправляемые в Nintendo, должны были иметь полностью правильный заголовок; ROMы, используемые для внутреннего тестирования, должны были пройти только проверку Boot ROMа, объясненную далее ниже.

Однако в наше "современное" время заголовок действительно имеет большое значение.
Эмуляторы (включая аппаратные эмуляторы, такие как флэш-картриджи) должны эмулировать аппаратное обеспечение, присутствующее в картридже.
Заголовок является единственным источником информации о том, какое оборудование должен содержать картридж ROMа, поэтому они полагаются на некоторые значения в заголовке.

## Boot ROM

Заголовок тесно связан с тем, что называется **Boot ROMом**.

Самые наблюдательные и/или ностальгирующие из вас, возможно, заметили отсутствие анимации загрузки и фирменного "ба-динь!" Game Boy в Emulicious.
Когда консоль включается, процессор начинает выполнять инструкции не по адресу $0100 (где находится точка входа нашего ROMа), а по адресу $0000.

Однако в это время небольшая программа под названием *boot ROM*, записанная в кремнии процессора, "накладывается" поверх нашего ROMа!
Boot ROM отвечает за анимацию запуска, также проверяя заголовок ROMа!
В частности, он проверяет правильность контрольных сумм логотипа Nintendo и заголовка; если ни одна из проверок не выполняется, Boot ROM намеренно *блокирует* все, и наша игра никогда не запустится :(

::: tip Для любознательных

Вы можете найти более подробное описание того, что делает Boot ROM [тут](https://github.com/LIJI32/SameBoy#compilation), а также объяснение проверки логотипа.
Однако имейте в виду, что материал довольно продвинутый.

Если вы хотите включить Boot ROM в Emulicious, вы должны получить копию Boot ROM(ов), контрольные суммы SHA256 которых можно найти в [дизассемблированном варианте](https://github.com/ISSOtm/gb-bootroms/blob/master/sha256sums.txt) для проверки.
Если вы хотите, вы также можете скомпилировать [Boot ROM SameBoy](https://github.com/LIJI32/SameBoy#compilation) и использовать их вместо этого в качестве замены свободного программного обеспечения.

Затем в настройках Emulicious перейдите на вкладку `Options`, потом `Emulation`→`Game Boy`, выберете GB и/или GBC boot rom'ы, которые вам нужны.
Наконец, задайте пути к Boot ROMам, которые вы хотите использовать, нажмите `Open`.
Теперь просто перезапустите эмулятор, и вуаля!

:::

Заголовок обычно называется "действительным", если он проходит проверку Boot ROM, и "недопустимым" в противном случае.

## RGBFIX

RGBFIX - это третий компонент RGBDS, предназначенный для записи заголовка ROMа.
Он отделен от RGBLINK, так что его можно использовать как автономный инструмент.
Его название происходит от того, что RGBLINK обычно не создает ROM с допустимым заголовком, поэтому ROM должен быть "исправлен", прежде чем он будет готов к использованию.

RGBFIX имеет [кучу флагов и опций](https://rgbds.gbdev.io/docs/rgbfix.1) для установки различных частей заголовка; но единственные два, которые мы здесь используем, - это `-v`, который создает правильный(**v**alid) заголовок (то есть, правильный [логотип Nintendo](https://gbdev.io/pandocs/The_Cartridge_Header.html#0104-0133---nintendo-logo) и [контрольные суммы](https://gbdev.io/pandocs/The_Cartridge_Header.html#014d---header-checksum)), и <code>-p&nbsp;0xFF</code>, который заполняет(**p**ads) ROM до следующего допустимого размера (используя $FF в качестве байта-заполнителя), и записывает соответствующее значение в [байт размера ROMа](https://gbdev.io/pandocs/The_Cartridge_Header.html#0148---rom-size)

Если вы посмотрите на другие проекты, вы можете найти вызовы RGBFIX с большим количеством опций, но эти два должны присутствовать почти всегда.

## Итак, в чем дело со строкой?

Точно!
Эта строка.

```rgbasm,linenos,start=7
{{#include ../assets/hello-world.asm:10}}
```

Что ж, давайте посмотрим, что произойдет, если мы удалим ее (или закомментируем).

```console
$ rgbasm -L -o hello-world.o hello-world.asm
$ rgblink -o hello-world.gb -n hello-world.sym hello-world.o
```

(Я намеренно не запускаю RGBFIX; через минуту мы увидим, почему.)

!["This rom would not work on a real gameboy."](../assets/img/bad_warnings.png)

Как я уже объяснял, RGBFIX отвечает за написание заголовка, поэтому мы должны использовать его для исправления этих предупреждений.

```console
$ rgbfix -v -p 0xFF hello-world.gb
warning: Overwrote a non-zero byte in the Nintendo logo
warning: Overwrote a non-zero byte in the header checksum
warning: Overwrote a non-zero byte in the global checksum
```

*Я уверен, что в этих предупреждениях нет ничего такого, о чем стоило бы беспокоиться...*
(В зависимости от вашей версии RGBDS вы могли получать разные предупреждения или вообще не получать их.)

Давайте запустим ROM, кликните на пункт Console внизу окна отладчика, нажмите <kbd><kbd>F5</kbd></kbd> несколько раз, и...

<figure>
  <img src="../assets/img/invalid_opcode.png" alt="Screenshot of Emulicious' debugger, PC won't advance past $0105">
  <figcaption>
    Когда консоль пишет "Executing illegal instruction", вы, <i>наверное</i>, где-то накосячили.
  </figcaption>
</figure>

!["This is fine" meme strip](../assets/img/fine.png)

Ладно, так что же случилось?

Как мы можем видеть на скриншоте, PC стоит на $0105.
Что он там делает?

...Ох, `EntryPoint` на $0103.
Итак, `jp` в $0100 отправился туда и начал выполнять инструкции (`3E CE` - это необработанная форма `ld a, $CE`), но затем $ED не кодирует ни одной действительной инструкции, поэтому процессор блокируется.

Но почему там находится `EntryPoint`?
Что ж, как вы, возможно, поняли из предупреждений, напечатанных RGBFIX, он *перезаписывает* область заголовка ROMа.
Однако RGBLINK **не** знает о заголовке (потому что RGBLINK используется не только для создания ROMов!), поэтому вы должны явно зарезервировать место для области заголовка.

::: danger:🥴

Забывание зарезервировать пространство и последующая перезапись фрагмента кода или данных - распространенная ошибка начинающих, которая может вызвать недоумение.
К счастью, RGBFIX начиная с версии 0.5.1 предупреждает при обнаружении этой ошибки, как показано выше.

:::

Итак, мы предотвращаем подобную катастрофу таким образом:

```rgbasm,linenos,start=3
{{#include ../assets/hello-world.asm:6:10}}
```

Директива `ds` означает "определить пространство" и позволяет заполнять диапазон памяти.
Эта конкретная строка заполняет все байты от $103 до $14F (включительно) значением $00.
Поскольку разные фрагменты кода и/или данных не могут перекрываться, это гарантирует, что диапазон памяти заголовка может быть безопасно перезаписан RGBFIX, и что вместо этого ничего другого случайно не будет обработано.

Может быть неочевидно, как этот "ds" в конечном итоге заполняет этот конкретный диапазон памяти.
3-байтовый `jp` охватывает адреса памяти $100, $101 и $102.
(Мы начинаем с $100, потому что именно там прописана `SECTION`.)
Когда RGBASM обрабатывает директиву `ds`, `@` (который является специальным символом, который вычисляется как "текущий адрес"), таким образом, имеет значение $103, поэтому он заполняет байты `$150 - $103 = $4D` нулями, $103, $104, ..., $14E, $14F.

## Бонус: бесконечный цикл

(На самом деле это не связано с заголовком, но мне нужно где-то это объяснить, и здесь такое же хорошее место, как и любое другое.)

Вам также может быть интересно, для чего нужен бесконечный цикл в конце кода.

```rgbasm
{{#include ../assets/hello-world.asm:68:69}}
```

Что ж, достаточно просто, процессор никогда не прекращает выполнять инструкции; поэтому, когда наш маленький Hello World завершен и делать больше нечего, мы все равно должны дать процессору немного работы: поэтому мы заставляем его прыгать назад вечно.

Мы не можем позволить процессору просто отключиться, так как тогда он начнет выполнять другие части памяти в виде кода, что может привести к сбою.
(Смотрите сами: удалите или закомментируйте эти две строки, повторно [скомпилируйте ROM](hello_world.md), и посмотрите, что произойдет!)